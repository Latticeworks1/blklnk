```markdown
# Ollama Monitoring Tools

This repository contains a suite of Python scripts designed to monitor Ollama instances, manage their health status, and handle related data.

**IMPORTANT NOTE:** The core scanning script, presumably named `shodan_scanner.py` (as referenced in launcher scripts like `quick_scan.py`), is currently **MISSING** from this repository. The setup process will create launcher scripts that attempt to call `shodan_scanner.py`, but these will fail until that script is provided.

## Table of Contents

- [Overview](#overview)
- [Scripts Included](#scripts-included)
  - [`setup.py`](#setuppy)
  - [`ollama_monitor.py`](#ollama_monitorpy)
  - [`data_export.py`](#data_exportpy)
  - [Launcher Scripts](#launcher-scripts)
- [Databases](#databases)
- [Setup and Installation](#setup-and-installation)
- [Usage](#usage)
  - [Initializing the System](#initializing-the-system)
  - [Running Health Checks](#running-health-checks)
  - [Continuous Monitoring](#continuous-monitoring)
  - [Exporting Data](#exporting-data)
  - [Viewing Statistics](#viewing-statistics)
- [Dependencies](#dependencies)
- [Contributing](#contributing)

## Overview

The primary goal of these tools is to maintain a database of Ollama endpoints and regularly check their health. `ollama_monitor.py` provides functionalities for initializing a database of endpoints from a dataset, performing health checks, and exporting data. `setup.py` automates the installation of dependencies and creation of necessary configuration files and launcher scripts.

## Scripts Included

### `setup.py`

This script automates the setup process for the Ollama monitoring tools.

**Functionality:**
- Installs required Python dependencies (see [Dependencies](#dependencies)).
- Creates a `config_template.py` file. You should copy this to `config.py` and add your Shodan API key.
- Generates launcher scripts (`quick_scan.py`, `continuous_scan.py`, `show_stats.py`) for easier execution of common tasks.
- Creates this `README.md` file.

**Usage:**
```bash
python setup.py
```
This command will install dependencies and create the necessary files.

### `ollama_monitor.py`

This is the main script for monitoring Ollama endpoints. It can initialize a database of hosts, perform health checks, and export data.

**Functionality:**
- Initializes a local SQLite database (`health.db`) with Ollama endpoints from a Parquet dataset (hosted on Hugging Face).
- Performs health checks on the stored endpoints by attempting to connect to their `/api/tags` endpoint.
- Stores health status (healthy, unhealthy, unknown), response time, model count, and model names.
- Implements a circuit breaker pattern to avoid repeatedly hitting failing endpoints.
- Provides options for continuous monitoring or single-cycle checks.
- Exports data in JSON, CSV, or Prometheus metrics format.
- Shows statistics about the monitored endpoints.

**Command-line Options:**
```
usage: ollama_monitor.py [-h] [--init] [--monitor] [--cycle]
                         [--export {json,csv,metrics}] [--stats]
                         [--interval INTERVAL]

Ollama Health Monitor

options:
  -h, --help            show this help message and exit
  --init                Initialize from dataset
  --monitor             Run continuous monitoring
  --cycle               Run single cycle
  --export {json,csv,metrics}
                        Export data
  --stats               Show statistics
  --interval INTERVAL   Check interval (seconds)
```

**Executable:** This script is made executable by `setup.py` and can be run directly:
```bash
./ollama_monitor.py <command>
```

### `data_export.py`

*(Assumed functionality based on name)*

This script is likely intended for exporting data from one or both of the SQLite databases (`health.db`, `ollama_hosts.db`). Its specific commands and output formats are not detailed here and would need to be confirmed by inspecting the script.

*(Users should refer to `python data_export.py --help` if such a script exists and is functional).*

### Launcher Scripts

These scripts are generated by `setup.py` for convenience. They attempt to use a **MISSING** script (`shodan_scanner.py`).

-   **`quick_scan.py`**:
    -   Intended to perform a one-time scan of Ollama instances using Shodan and then validate them.
    -   **Requires `shodan_scanner.py` to be present and functional.**
    -   References `config.py` for Shodan API key and other settings.
-   **`continuous_scan.py`**:
    -   Intended to run scans periodically.
    -   **Requires `shodan_scanner.py` to be present and functional.**
    -   References `config.py`.
-   **`show_stats.py`**:
    -   Intended to display statistics, likely from the `shodan_scanner.py` operations and its database (`ollama_hosts.db`).
    -   **Requires `shodan_scanner.py` to be present and functional.**
    -   References `config.py`.

## Databases

This project uses two distinct SQLite database files:

1.  **`health.db`**:
    -   Managed by `ollama_monitor.py`.
    -   Stores the list of Ollama endpoints, their health status, response times, model details, and other monitoring-related metadata.
    -   Initialized from a Parquet dataset.

2.  **`ollama_hosts.db`**:
    -   This database is referenced in `config_template.py` (`DATABASE_PATH = "ollama_hosts.db"`).
    -   It is presumably created and managed by the **MISSING** `shodan_scanner.py` script.
    -   Likely stores raw results from Shodan queries and results of initial validation before being processed further or alongside `health.db`.

## Setup and Installation

1.  **Clone the repository (if you haven't already):**
    ```bash
    # git clone <repository_url>
    # cd <repository_directory>
    ```

2.  **Run the setup script:**
    ```bash
    python setup.py
    ```
    This will install dependencies (listed below) and create `config_template.py`, launcher scripts, and this `README.md`.

3.  **Configure `config.py`:**
    -   Copy `config_template.py` to `config.py`:
        ```bash
        cp config_template.py config.py
        ```
    -   Edit `config.py` and add your Shodan API key:
        ```python
        SHODAN_API_KEY = "YOUR_SHODAN_API_KEY_HERE"
        ```
    -   You can also customize `DATABASE_PATH` (default is `ollama_hosts.db` for the Shodan part) and other settings in `config.py`.

4.  **Initialize the `ollama_monitor.py` database:**
    To populate `health.db` with endpoints for monitoring:
    ```bash
    python ollama_monitor.py --init
    # or ./ollama_monitor.py --init
    ```
    This downloads a dataset of Ollama hosts and initializes the `health.db` database.

## Usage

Ensure you have completed the [Setup and Installation](#setup-and-installation) steps.

### Initializing the System
(Covered in step 4 of Setup and Installation)

### Running Health Checks

To perform a single health check cycle on the endpoints in `health.db`:
```bash
python ollama_monitor.py --cycle
# or ./ollama_monitor.py --cycle
```

### Continuous Monitoring

To run `ollama_monitor.py` in continuous mode, checking endpoints at a defined interval:
```bash
python ollama_monitor.py --monitor --interval 300
# or ./ollama_monitor.py --monitor --interval 300
```
(Default interval is 300 seconds if not specified)

### Exporting Data

From `ollama_monitor.py` (exports data from `health.db`):
```bash
# Export in JSON format
python ollama_monitor.py --export json

# Export in CSV format
python ollama_monitor.py --export csv

# Export in Prometheus metrics format
python ollama_monitor.py --export metrics
```
This will create files like `ollama_endpoints.json`, `ollama_endpoints.csv`, or `ollama_metrics.txt`.

### Viewing Statistics

From `ollama_monitor.py` (shows statistics from `health.db` and runtime metrics):
```bash
python ollama_monitor.py --stats
# or ./ollama_monitor.py --stats
```

**Note on Launcher Scripts (`quick_scan.py`, etc.):** As mentioned, these scripts depend on the missing `shodan_scanner.py`. If that script were present, you would use them as follows:
```bash
# python quick_scan.py
# python continuous_scan.py
# python show_stats.py
```

## Dependencies

The `setup.py` script will attempt to install the following core dependencies:

-   `shodan>=1.28.0`
-   `aiohttp>=3.8.0`
-   `asyncio` (built-in with Python 3.8+)
-   `sqlite3` (built-in with Python)
-   `pyarrow` (for reading Parquet datasets in `ollama_monitor.py`)

And optional dependencies (also installed by `setup.py`):

-   `pandas>=1.5.0` (used by `ollama_monitor.py` for dataset loading)
-   `rich>=10.0.0` (for potentially prettier console output, though not explicitly used in current script outputs)

## Contributing

Contributions are welcome! If you are addressing the missing `shodan_scanner.py`, improving existing scripts, or adding new features, please follow these general steps:

1.  Fork the repository.
2.  Create a new branch for your feature or bug fix.
3.  Make your changes.
4.  Ensure your code is well-documented and tested if applicable.
5.  Submit a pull request with a clear description of your changes.

```
